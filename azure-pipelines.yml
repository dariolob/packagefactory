trigger: none   # oppure: - main per trigger automatici

pool:
  vmImage: 'windows-latest'    # oppure un agente self-hosted Windows

# Le secret stanno in Azure DevOps (Library -> Variable Group)
variables:
- group: IntuneCredentials      # contiene TENANT_ID / CLIENT_ID / CLIENT_SECRET
- name: INTUNE_TENANT
  value: $(TENANT_ID)
- name: INTUNE_APPID
  value: $(CLIENT_ID)
- name: INTUNE_KEY
  value: $(CLIENT_SECRET)

steps:

# 1) Checkout del repository GitHub
- checkout: self
  clean: true

# 2–4) Tutto in un singolo processo PowerShell per mantenere il token valido
- task: PowerShell@2
  displayName: "Install modules + Update Evergreen + Connect + Run PSPackageFactory"
  inputs:
    targetType: inline
    workingDirectory: "$(Build.SourcesDirectory)"
    script: |
      Write-Host "=== INSTALL REQUIRED MODULES IF NEEDED ==="
      $modules = @('IntuneWin32App','Evergreen','VcRedist','MSAL.PS')
      foreach ($m in $modules) {
        if (-not (Get-Module -ListAvailable -Name $m)) {
          Write-Host "Installing module $m..."
          Install-Module -Name $m -Force -SkipPublisherCheck
        } else {
          Write-Host "Module $m already installed."
        }
      }

      Write-Host "=== UPDATE EVERGREEN PACKAGE DEFINITIONS ==="
      Import-Module Evergreen -Force
      Update-Evergreen -Force   # richiesto se il runner è effimero (windows-latest)

      Write-Host "=== AUTHENTICATING TO MICROSOFT GRAPH VIA APP REGISTRATION ==="
      $paramsAuth = @{
        TenantId     = "$(INTUNE_TENANT)"
        ClientId     = "$(INTUNE_APPID)"
        ClientSecret = "$(INTUNE_KEY)"
      }
      Connect-MSIntuneGraph @paramsAuth

      Write-Host "=== RUN PSPACKAGEFACTORY ==="
      $params = @{
        Path        = ".\packages"
        Application = "MozillaFirefox"   # MODIFICA QUI LE APP
        Type        = "App"
        WorkingPath = ".\output"
        Import      = $true
      }

      .\New-Win32Package.ps1 @params -Verbose