trigger: none   # no triggers since this is just a demo

pool:
  vmImage: 'windows-latest'    # we may self-host for persistency

# secrets are stored in Azure DevOps (Library -> Variable Group)
variables:
- group: IntuneCredentials      # TENANT_ID / CLIENT_ID / CERT_PASS
- name: INTUNE_TENANT
  value: $(TENANT_ID)
- name: INTUNE_APPID
  value: $(CLIENT_ID)
- name: INTUNE_CERT_PASSWORD
  value: $(CERT_PASS)           
- name: INTUNE_PFX_NAME
  value: "IntuneAutomation.pfx" 

steps:

# GitHub checkout
- checkout: self
  clean: true


# === IMPORT PFX  ===
- task: DownloadSecureFile@1
  name: downloadedPfx
  inputs:
    secureFile: $(INTUNE_PFX_NAME)

- task: PowerShell@2
  displayName: "Import PFX into Cert Store"
  inputs:
    targetType: inline
    script: |
      Write-Host "=== IMPORTING PRIVATE CERTIFICATE (.PFX) INTO CURRENTUSER STORE ==="
      $pfxPath = "$(downloadedPfx.secureFilePath)"
      $password = "$(INTUNE_CERT_PASSWORD)" | ConvertTo-SecureString -AsPlainText -Force

      # Import certificato con PRIVATE KEY (fondamentale)
      $cert = Import-PfxCertificate `
          -FilePath $pfxPath `
          -Password $password `
          -Exportable `
          -CertStoreLocation "Cert:\CurrentUser\My"

      Write-Host "Imported certificate thumbprint: $($cert.Thumbprint)"
      Write-Host "##vso[task.setvariable variable=CERT_THUMBPRINT]$($cert.Thumbprint)"

      # Test della presenza della private key
      $certTest = Get-Item "Cert:\CurrentUser\My\$($cert.Thumbprint)"
      Write-Host "CERTIFICATE HAS PRIVATE KEY: $($certTest.HasPrivateKey)"

      if (-not $certTest.HasPrivateKey) {
        Write-Error "❌ Il certificato non contiene la PRIVATE KEY. Impossibile autenticarsi con Connect‑MSIntuneGraph."
      }


# Install modules + Update Evergreen + Connect + Run PSPackageFactory
- task: PowerShell@2
  displayName: "Install modules + Update Evergreen + Connect + Run PSPackageFactory"
  inputs:
    targetType: inline
    workingDirectory: "$(Build.SourcesDirectory)"
    script: |
      Write-Host "=== INSTALL REQUIRED MODULES IF NEEDED ==="
      $modules = @('IntuneWin32App','Evergreen','VcRedist','MSAL.PS')
      foreach ($m in $modules) {
        if (-not (Get-Module -ListAvailable -Name $m)) {
          Write-Host "Installing module $m..."
          Install-Module -Name $m -Force -SkipPublisherCheck
        } else {
          Write-Host "Module $m already installed."
        }
      }

      Write-Host "=== UPDATE EVERGREEN PACKAGE DEFINITIONS ==="
      Import-Module Evergreen -Force
      Update-Evergreen -Force  

      Write-Host "=== AUTHENTICATING TO MICROSOFT GRAPH VIA CERTIFICATE ==="
      $cert = Get-Item "Cert:\CurrentUser\My\$(CERT_THUMBPRINT)"

      $paramsAuth = @{
        TenantId   = "$(INTUNE_TENANT)"
        ClientId   = "$(INTUNE_APPID)"
        ClientCert = $cert
      }

      Connect-MSIntuneGraph @paramsAuth -Verbose

      Write-Host "=== RUN PSPACKAGEFACTORY ==="
      $params = @{
        Path        = ".\packages"
        Application = "CitrixWorkspaceAppLTSR"   # App list here
        Type        = "App"
        WorkingPath = ".\output"
        Import      = $true
      }

      .\New-Win32Package.ps1 @params -Verbose