trigger: none   # no triggers since this is just a demo

pool:
  vmImage: 'windows-latest'    # we may self-host for persistency

# secrets are stored in Azure DevOps (Library -> Variable Group)
variables:
- group: IntuneCredentials      # TENANT_ID / CLIENT_ID / CLIENT_SECRET
- name: INTUNE_TENANT
  value: $(TENANT_ID)
- name: INTUNE_APPID
  value: $(CLIENT_ID)
- name: INTUNE_KEY
  value: $(CLIENT_SECRET)

steps:

# GitHub checkout
- checkout: self
  clean: true


- task: PowerShell@2
  displayName: "Install modules + Update Evergreen + Connect + Run PSPackageFactory"
  inputs:
    targetType: inline
    workingDirectory: "$(Build.SourcesDirectory)"
    script: |
      Write-Host "=== INSTALL REQUIRED MODULES IF NEEDED ==="
      $modules = @('IntuneWin32App','Evergreen','VcRedist','MSAL.PS')
      foreach ($m in $modules) {
        if (-not (Get-Module -ListAvailable -Name $m)) {
          Write-Host "Installing module $m..."
          Install-Module -Name $m -Force -SkipPublisherCheck
        } else {
          Write-Host "Module $m already installed."
        }
      }

      Write-Host "=== UPDATE EVERGREEN PACKAGE DEFINITIONS ==="
      Import-Module Evergreen -Force
      Update-Evergreen -Force  

      Write-Host "=== AUTHENTICATING TO MICROSOFT GRAPH VIA APP REGISTRATION ==="
      $paramsAuth = @{
        TenantId     = "$(INTUNE_TENANT)"
        ClientId     = "$(INTUNE_APPID)"
        ClientSecret = "$(INTUNE_KEY)"
      }
      Connect-MSIntuneGraph @paramsAuth

      Write-Host "=== RUN PSPACKAGEFACTORY ==="
      $params = @{
        Path        = ".\packages"
        Application = "Notepad++"   # App list here
        Type        = "App"
        WorkingPath = ".\output"
        Import      = $true
      }

      .\New-Win32Package.ps1 @params -Verbose